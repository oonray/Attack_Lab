apiVersion: apps/v1
kind: Deployment
metadata:
    name: mitmproxy
    labels:
      app: mitmproxy
spec:
    replicas: 1
    selector:
        matchLabels:
            app: mitmproxy
    template:
        metadata:
            labels:
                app: mitmproxy
        spec:
            volumes:
                - name: tools
                  configMap:
                    name: tools

                - name: vpn-config
                  secret:
                    secretName: vpn-config
                    items:
                      - key: vpn.ovpn
                        path: vpn.ovpn

                - name: route-script
                  configMap:
                    name: opnevpn-script
                    items:
                      - key: route-override.sh
                        path: route-override.sh

                - name: busybox-script
                  configMap:
                    name: buisybox-insall-script
                    items:
                      - key: install.sh
                        path: install.sh

                - name: tmux-conf
                  configMap:
                    name: tmux
                    items:
                      - key: .tmux.conf
                        path: .tmux.conf

                - name: tmp
                  emptyDir: {}

                - name: thm-storage
                  hostPath:
                    path: /disk1/kubernetes/HTB
                    type: Directory

            dnsConfig:
              nameservers:
                - 8.8.8.8
            containers:
                - name: mitmproxy
                  image: mitmproxy/mitmproxy
                  args:
                    - mitmweb
                    - '--web-host'
                    -  0.0.0.0
                  ports:
                    - containerPort: 8080
                    - containerPort: 8081
                    - containerPort: 1337
                  resources:
                    limits:
                      memory: "500Mi"
                      cpu: "1"
                  volumeMounts:
                    - mountPath: /opt/HTB
                      name: thm-storage

                - name: openvpn
                  image: dperson/openvpn-client
                  tty: true
                  stdin: true
                  command: ["/bin/sh","-c"]
                  args: ["openvpn --config '/vpn/vpn.ovpn' --script-security 3"]
                  securityContext:
                      privileged: true
                      capabilities:
                        add:
                          - NET_ADMIN
                  env:
                      - name: TZ
                        value: "Norway"
                  volumeMounts:
                    - name:  vpn-config
                      mountPath:  /vpn/vpn.ovpn
                      subPath: vpn.ovpn
                    - name: tmp
                      mountPath: /tmp/route
                  resources:
                    limits:
                      memory: "1Gi"
                      cpu: "0.5"
